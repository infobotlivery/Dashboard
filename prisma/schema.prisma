generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Métricas semanales - Dashboard de 7 métricas
model WeeklyMetric {
  id                 Int      @id @default(autoincrement())
  weekStart          DateTime @unique // Inicio de semana (lunes)
  mrr                Float    @default(0) // MRR Clientes - Ingresos recurrentes de clientes
  mrrComunidad       Float    @default(0) // MRR Comunidad - Ingresos recurrentes de comunidad
  pipelineActivo     Int      @default(0) // Oportunidades en conversación (leads calientes)
  cierresSemana      Float    @default(0) // Ventas cerradas (monto)
  contenidoPublicado Int      @default(0) // Piezas de contenido creadas
  leadsEntrantes     Int      @default(0) // Personas nuevas que preguntaron
  entregasPendientes Int      @default(0) // Proyectos en ejecución sin cerrar
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// Scorecard mensual
model MonthlyScorecard {
  id                    Int      @id @default(autoincrement())
  month                 DateTime @unique // Primer día del mes
  facturacionTotal      Float    @default(0)
  mrr                   Float    @default(0)
  clientesNuevos        Int      @default(0)
  clientesPerdidos      Int      @default(0)
  enigmaVendidos        Int      @default(0)
  serviciosRecurrentes  Int      @default(0)
  leadsTotales          Int      @default(0)
  tasaCierre            Float    @default(0) // Porcentaje
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// Checks diarios
model DailyCheck {
  id               Int      @id @default(autoincrement())
  date             DateTime @unique
  publicoContenido Boolean  @default(false)
  respondioLeads   Boolean  @default(false)
  notas            String?
  createdAt        DateTime @default(now())
}

// Configuración de admin y branding
model AdminSettings {
  id           Int     @id @default(1)
  passwordHash String
  brandPrimary String  @default("#44e1fc")
  brandDark    String  @default("#171717")
  logoUrl      String?
}

// Registro de cierres de ventas
model SalesClose {
  id              Int       @id @default(autoincrement())
  clientName      String                              // Nombre del cliente
  product         String                              // Enigma, CRM, Agente IA, Asesoría, Otro
  customProduct   String?                             // Solo si product = "Otro"
  onboardingValue Float     @default(0)               // Pago único
  recurringValue  Float     @default(0)               // Pago mensual (suma a MRR si activo)
  contractMonths  Int?                                // Duración contrato (meses)
  status          String    @default("active")        // active, cancelled, completed
  createdAt       DateTime  @default(now())           // Fecha registro
  cancelledAt     DateTime?                           // Fecha de cancelación
  updatedAt       DateTime  @updatedAt
}

// Log de webhooks de Kommo CRM - Auditoría de leads calificados
model KommoWebhookLog {
  id             Int      @id @default(autoincrement())
  leadId         Int                                  // ID del lead en Kommo
  leadName       String                               // Nombre del lead
  fromStage      String?                              // Etapa anterior (puede ser null)
  toStage        String                               // Etapa nueva (Calificado)
  action         String                               // "increment"
  pipelineActivo Int                                  // Valor después de la acción
  createdAt      DateTime @default(now())             // Cuándo ocurrió
}

// =====================================================
// DASHBOARD FINANCIERO PRIVADO
// =====================================================

// Categorías de gastos personalizadas
model ExpenseCategory {
  id        Int       @id @default(autoincrement())
  name      String    @unique                        // "Herramientas", "Marketing", etc.
  color     String    @default("#44e1fc")            // Color para visualización
  expenses  Expense[]
  createdAt DateTime  @default(now())
}

// Registro de gastos
model Expense {
  id          Int              @id @default(autoincrement())
  name        String                                 // "Cursor Pro", "ChatGPT Plus"
  amount      Float                                  // Monto
  type        String           @default("recurring") // "fixed" | "recurring"
  categoryId  Int
  category    ExpenseCategory  @relation(fields: [categoryId], references: [id])
  startDate   DateTime         @default(now())       // Cuándo empezó
  endDate     DateTime?                              // Si terminó (para recurrentes cancelados)
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

// Snapshot mensual de finanzas (para histórico)
model MonthlyFinance {
  id               Int      @id @default(autoincrement())
  month            DateTime @unique                  // Primer día del mes
  totalIncome      Float    @default(0)              // Onboarding + MRR
  totalOnboarding  Float    @default(0)              // Solo onboarding del mes
  totalMrrServices Float    @default(0)              // MRR de clientes activos
  totalMrrCommunity Float   @default(0)              // MRR de comunidad
  totalExpenses    Float    @default(0)              // Total gastos del mes
  netProfit        Float    @default(0)              // Ingresos - Gastos
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// Metas mensuales financieras
model MonthlyGoal {
  id            Int      @id @default(autoincrement())
  month         DateTime @unique                      // Primer día del mes
  incomeTarget  Float    @default(0)                  // Meta de ingresos
  expenseLimit  Float    @default(0)                  // Límite de gastos
  savingsTarget Float    @default(0)                  // Meta de ahorro
  notes         String?                               // Notas adicionales
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
